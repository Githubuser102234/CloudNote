<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Cloud Notes</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Apply Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom scrollbar for better aesthetics */
        .notes-list::-webkit-scrollbar, .editor-content::-webkit-scrollbar {
            width: 6px;
        }

        .notes-list::-webkit-scrollbar-thumb, .editor-content::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 3px;
        }

        .notes-list::-webkit-scrollbar-thumb:hover, .editor-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- *** 1. Loading Spinner Overlay *** -->
    <div id="loading-spinner-overlay" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-[300]">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-t-indigo-500 border-gray-200 mb-3"></div>
            <p class="text-indigo-600 font-medium">Loading Application...</p>
        </div>
    </div>
    
    <!-- *** 2. Auth Modal/Overlay (Controlled by routing) *** -->
    <div id="auth-overlay" class="fixed inset-0 bg-white flex items-center justify-center z-[200] hidden">
        <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 border border-gray-100">
            <h3 id="auth-title" class="text-3xl font-bold text-gray-900 mb-6 text-center">Sign In</h3>
            
            <div id="auth-message" class="text-sm text-center text-red-500 mb-4 hidden"></div>

            <!-- Email/Password Form Fields -->
            <input id="auth-email" type="email" placeholder="Email" class="w-full mb-3 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            <input id="auth-password" type="password" placeholder="Password" class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">

            <!-- Primary Auth Actions -->
            <button id="auth-primary-btn" class="w-full py-3 mb-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 active:scale-[.99]">
                Sign In
            </button>
            
            <div class="relative flex items-center justify-center mb-4">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <!-- Google Sign In -->
            <button id="auth-google-btn" class="w-full py-3 flex items-center justify-center space-x-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition duration-150 active:scale-[.99]">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.0004 0C8.42398 0 5.25301 1.44299 3.01168 3.73802L7.04286 7.42701C8.24522 6.55118 9.94729 6.00282 12.0004 6.00282C13.8427 6.00282 15.6548 6.6416 17.0628 7.74758L21.0939 4.05859C18.8526 1.76356 15.6816 0.000183105 12.0004 0.000183105V0ZM2.75 6.00004C1.94297 7.2185 1.50005 8.57024 1.50005 9.99999C1.50005 11.4297 1.94297 12.7815 2.75 14L6.78119 10.311C6.78119 10.311 6.81261 10.0381 6.81261 9.99999C6.81261 9.96188 6.78119 9.68903 6.78119 9.68903L2.75 6.00004ZM12.0004 24C15.6816 24 18.8526 22.2364 21.0939 19.9414L17.0628 16.2524C15.6548 17.3584 13.8427 17.9972 12.0004 17.9972C9.94729 17.9972 8.24522 17.4488 7.04286 16.573L3.01168 20.262C5.25301 22.557 8.42398 24 12.0004 24Z" fill="#EA4335"/>
                </svg>
                Sign in with Google
            </button>

            <!-- Secondary Auth Actions -->
            <div class="text-center mt-6 text-sm flex justify-between">
                <a id="auth-toggle-link" href="#/signup" class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-150">
                    Need an account? Sign Up
                </a>
                <a id="auth-reset-link" href="#/reset" class="text-gray-500 hover:text-gray-700 transition duration-150">
                    Forgot Password?
                </a>
            </div>
            
        </div>
    </div>
    
    <!-- *** 3. Main Application Container (Hidden until authenticated) *** -->
    <div id="app" class="flex flex-1 overflow-hidden h-screen hidden">
        
        <!-- Note List (Sidebar on desktop, full-screen on mobile when no note is selected) -->
        <div id="note-list-container" class="w-full md:w-80 border-r border-gray-200 bg-white flex flex-col transition-transform duration-300 ease-in-out">
            <div class="p-4 border-b border-gray-200 shadow-sm flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">My Notes</h1>
                <div class="flex space-x-2 items-center">
                    <button id="new-note-btn" title="New Note" class="p-2 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 active:scale-95">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button id="signout-btn" title="Sign Out" class="p-2 text-gray-500 rounded-full hover:bg-gray-100 transition duration-150 active:scale-95">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div id="notes-list" class="notes-list flex-1 overflow-y-auto p-2">
                <!-- Notes will be injected here -->
            </div>

            <div class="p-2 text-xs text-gray-500 border-t border-gray-100 text-center">
                <p>User ID: <span id="user-id-display" class="font-mono text-indigo-500 break-all">...</span></p>
            </div>
        </div>

        <!-- Note Editor -->
        <div id="note-editor-container" class="flex-1 flex-col bg-white md:flex hidden">
            <!-- Editor Header -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 shadow-sm">
                <button id="back-to-list-btn" class="text-indigo-600 md:hidden p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition duration-150">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div class="flex items-center space-x-3 ml-auto">
                    <span id="last-edited-time" class="text-xs text-gray-500">Last edited: --</span>
                    <button id="delete-note-btn" title="Delete Note" class="p-2 text-red-500 rounded-lg hover:bg-red-50 transition duration-150 active:scale-95">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Editor Body -->
            <div id="editor-body" class="flex-1 overflow-y-auto p-6 space-y-4">
                <input id="note-title" type="text" placeholder="Title your note" class="w-full text-3xl font-bold border-none focus:ring-0 focus:outline-none placeholder-gray-300 p-0 text-gray-900">
                <textarea id="note-content" placeholder="Start typing here..." class="editor-content w-full h-full text-lg border-none focus:ring-0 focus:outline-none resize-none placeholder-gray-400 p-0 text-gray-700"></textarea>
            </div>
        </div>

        <!-- Empty State for Editor -->
        <div id="empty-editor-state" class="flex-1 flex-col items-center justify-center text-gray-400 p-6 md:flex hidden">
            <i data-lucide="notebook-pen" class="w-16 h-16 mb-4"></i>
            <p class="text-xl font-medium">Select a note or create a new one</p>
        </div>
    </div>

    <!-- Confirmation Modal (for Delete) -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform scale-100 transition-transform duration-300">
            <h3 class="text-xl font-semibold text-gray-800 mb-3">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this note? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 transition duration-150">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP ---

        // Set Firebase Log Level
        setLogLevel('Debug');

        // Provided Firebase Configuration
        const PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBqObkmL_fZeeAoaS4weJGx7VU4CskppuQ",
            authDomain: "cloudnote-be55c.firebaseapp.com",
            projectId: "cloudnote-be55c",
            storageBucket: "cloudnote-be55c.firebasestorage.app",
            messagingSenderId: "744575504537",
            appId: "1:744575504537:web:2b76ec5ca81faca23a6808",
            measurementId: "G-LQY0X53JGF"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : PROVIDED_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        // Global Firebase Instances
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let googleProvider = null; // New global variable for Google Provider

        let userId = null;
        let isAuthReady = false; // Indicates if auth listener has completed its first check

        let notesData = [];
        let activeNoteId = null;
        let saveTimer = null;
        let authMode = 'signin';
        let unsubscribeNotes = null;

        // --- DOM Elements ---
        const loadingSpinnerOverlay = document.getElementById('loading-spinner-overlay');
        const appContainer = document.getElementById('app');
        const authOverlay = document.getElementById('auth-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const notesListElement = document.getElementById('notes-list');
        const newNoteBtn = document.getElementById('new-note-btn');
        const noteTitleInput = document.getElementById('note-title');
        const noteContentTextarea = document.getElementById('note-content');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const lastEditedTimeSpan = document.getElementById('last-edited-time');
        const noteEditorContainer = document.getElementById('note-editor-container');
        const emptyEditorState = document.getElementById('empty-editor-state');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // Auth Form Elements
        const authTitle = document.getElementById('auth-title');
        const authMessage = document.getElementById('auth-message');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authPrimaryBtn = document.getElementById('auth-primary-btn');
        const authGoogleBtn = document.getElementById('auth-google-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authResetLink = document.getElementById('auth-reset-link');


        // --- FIREBASE INITIALIZATION & AUTH ---

        const initializeFirebase = () => {
            // Initialize Core App, Auth, and Firestore
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);
            googleProvider = new GoogleAuthProvider(); // Instantiate the provider

            // Listen for Auth State Changes
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true; // Auth check is done
                loadingSpinnerOverlay.classList.add('hidden'); // Hide loading spinner

                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    
                    // Show app, hide auth
                    authOverlay.classList.add('hidden');
                    appContainer.classList.remove('hidden');

                    // Start listening for notes and handle the current route
                    startNoteListener();
                    handleRouting();
                    
                } else {
                    // User is signed out.
                    userId = null;
                    notesData = [];
                    setActiveNote(null, false);

                    // Stop listening to old notes
                    if (unsubscribeNotes) {
                        unsubscribeNotes();
                        unsubscribeNotes = null;
                    }

                    // Force routing to signin/signup screen and show overlay
                    if (!window.location.hash.startsWith('#/signup') && !window.location.hash.startsWith('#/reset')) {
                        window.location.hash = '#/signin';
                    }
                    authOverlay.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    handleRouting(); 
                }
            });
        };

        // --- ROUTING & UI MANAGEMENT ---

        const handleRouting = () => {
            let hash = window.location.hash || '#/';
            
            // Only proceed if Auth is ready
            if (!isAuthReady) return;
            
            if (userId) {
                // AUTHENTICATED ROUTES
                authOverlay.classList.add('hidden');
                
                if (hash.startsWith('#/notes/')) {
                    const noteId = hash.substring(8);
                    setActiveNote(noteId, false); // Do not force re-route
                } else {
                    setActiveNote(null, false); // Show list view
                }

            } else {
                // UNAUTHENTICATED ROUTES
                authOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');

                if (hash === '#/signup') {
                    setAuthMode('signup');
                } else if (hash === '#/reset') {
                    setAuthMode('reset');
                } else {
                    // Default to signin if not recognized
                    setAuthMode('signin');
                }
            }
        };

        const setAuthMessage = (message, isError = true) => {
            authMessage.textContent = message;
            authMessage.className = `text-sm text-center mb-4 ${isError ? 'text-red-500' : 'text-green-600'}`;
            authMessage.classList.remove('hidden');
        };

        const setAuthMode = (mode) => {
            authMode = mode;
            authMessage.classList.add('hidden');
            authPasswordInput.classList.remove('hidden');
            authGoogleBtn.classList.remove('hidden');
            authResetLink.classList.remove('hidden');
            
            // Clear input values when switching mode for a cleaner experience
            authEmailInput.value = '';
            authPasswordInput.value = '';

            switch (mode) {
                case 'signin':
                    authTitle.textContent = 'Sign In';
                    authPrimaryBtn.textContent = 'Sign In';
                    authToggleLink.textContent = 'Need an account? Sign Up';
                    authToggleLink.href = '#/signup';
                    break;
                case 'signup':
                    authTitle.textContent = 'Sign Up';
                    authPrimaryBtn.textContent = 'Sign Up';
                    authToggleLink.textContent = 'Already have an account? Sign In';
                    authToggleLink.href = '#/signin';
                    authResetLink.classList.add('hidden');
                    break;
                case 'reset':
                    authTitle.textContent = 'Reset Password';
                    authPrimaryBtn.textContent = 'Send Reset Email';
                    authPasswordInput.classList.add('hidden');
                    authGoogleBtn.classList.add('hidden');
                    authResetLink.classList.add('hidden');
                    authToggleLink.textContent = 'Back to Sign In';
                    authToggleLink.href = '#/signin';
                    break;
            }
        };

        const handlePrimaryAuthAction = async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (authMode !== 'reset' && (!email || !password)) {
                setAuthMessage("Please enter both email and password.");
                return;
            }
            if (authMode === 'reset' && !email) {
                 setAuthMessage("Please enter your email address.");
                return;
            }

            try {
                authPrimaryBtn.disabled = true;
                authPrimaryBtn.textContent = 'Processing...';

                if (authMode === 'signin') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else if (authMode === 'signup') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else if (authMode === 'reset') {
                    await sendPasswordResetEmail(auth, email);
                    window.location.hash = '#/signin'; // Route back to signin after sending
                    setAuthMessage("Password reset email sent. Check your inbox!", false);
                }
                
            } catch (error) {
                let errorMessage = error.message || "An unknown error occurred.";
                if (error.code) {
                     errorMessage = error.code.replace('auth/', '').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                }
                setAuthMessage(errorMessage);
            } finally {
                authPrimaryBtn.disabled = false;
                if (authMode !== 'reset') {
                    authPrimaryBtn.textContent = authMode === 'signin' ? 'Sign In' : 'Sign Up';
                }
            }
        };

        const handleGoogleSignIn = async () => {
            // Check that auth and provider are initialized (Fix for "null is not an object")
            if (!auth || !googleProvider) {
                setAuthMessage("Authentication service is not fully initialized. Please wait.", true);
                return;
            }
            try {
                authGoogleBtn.disabled = true;
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error("Google Sign In Error:", error);
                setAuthMessage("Google Sign In Failed: " + (error.message || 'Unknown Error'));
            } finally {
                 authGoogleBtn.disabled = false;
            }
        };

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener handles the UI cleanup and routing
            } catch (error) {
                console.error("Sign out error:", error);
            }
        };


        // --- FIRESTORE OPERATIONS ---

        const getNotesCollectionRef = () => {
            if (!db || !userId) return null;
            // Private Data Path: /artifacts/{appId}/users/{userId}/notes
            const path = `artifacts/${appId}/users/${userId}/notes`;
            return collection(db, path);
        };

        // Real-time listener for notes
        const startNoteListener = () => {
            const notesRef = getNotesCollectionRef();
            if (!notesRef) return;
            
            // If already subscribed, unsubscribe first
            if (unsubscribeNotes) {
                unsubscribeNotes();
            }

            const q = query(notesRef);

            unsubscribeNotes = onSnapshot(q, (snapshot) => {
                const newNotes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    updatedAt: doc.data().updatedAt?.toDate() || new Date(0)
                }));

                notesData = newNotes.sort((a, b) => b.updatedAt - a.curated);
                renderNoteList();

                // If the active note was deleted by another client/process, redirect to list
                if (activeNoteId && !notesData.find(note => note.id === activeNoteId)) {
                    window.location.hash = '#/';
                }
            }, (error) => {
                console.error("Error listening to notes:", error);
            });
        };

        const createNewNote = async () => {
            if (!userId) return;

            const notesRef = getNotesCollectionRef();
            if (!notesRef) return;

            try {
                const newNote = {
                    title: "New Note",
                    content: "",
                    updatedAt: serverTimestamp()
                };
                const docRef = await addDoc(notesRef, newNote);
                // Route to the new note immediately
                window.location.hash = `#/notes/${docRef.id}`;
            } catch (error) {
                console.error("Error creating new note:", error);
            }
        };

        const saveActiveNote = async (title, content) => {
            if (!activeNoteId || !userId) return;

            const notesRef = getNotesCollectionRef();
            if (!notesRef) return;

            try {
                const noteDocRef = doc(notesRef, activeNoteId);
                await updateDoc(noteDocRef, {
                    title: title || '(No Title)',
                    content: content,
                    updatedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving note:", error);
            }
        };

        const deleteNote = async () => {
            if (!activeNoteId || !userId) return;

            const notesRef = getNotesCollectionRef();
            if (!notesRef) return;

            try {
                const noteDocRef = doc(notesRef, activeNoteId);
                await deleteDoc(noteDocRef);
                window.location.hash = '#/'; // Route back to the list
            } catch (error) {
                console.error("Error deleting note:", error);
            }
        };

        // --- UI RENDERING & DISPLAY ---

        const formatTimestamp = (date) => {
            if (!date || date.getTime() === 0) return '--';
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (date >= today) {
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (date >= yesterday) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
        };

        const renderNoteList = () => {
            notesListElement.innerHTML = '';
            // Ensure data is sorted by updatedAt, newest first
            notesData.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime());

            notesData.forEach(note => {
                const isActive = note.id === activeNoteId;
                const noteItem = document.createElement('a');
                noteItem.href = `#/notes/${note.id}`;
                noteItem.className = `p-4 mb-2 rounded-xl cursor-pointer block transition duration-150 ${isActive ? 'bg-indigo-100 ring-2 ring-indigo-500 shadow-md' : 'bg-gray-50 hover:bg-gray-100'}`;
                noteItem.innerHTML = `
                    <h3 class="font-semibold ${isActive ? 'text-indigo-800' : 'text-gray-800'} truncate">${note.title || '(No Title)'}</h3>
                    <p class="text-xs text-gray-500 mb-1">${formatTimestamp(note.updatedAt)}</p>
                    <p class="text-sm text-gray-600 line-clamp-2">${note.content?.substring(0, 100) || 'Empty note...'}</p>
                `;
                notesListElement.appendChild(noteItem);
            });
        };

        const setActiveNote = (noteId) => {
            activeNoteId = noteId;
            const activeNote = notesData.find(note => note.id === noteId);

            const isMobile = window.innerWidth < 768;

            if (activeNote) {
                // Show Editor, Hide Empty State
                noteEditorContainer.classList.remove('hidden');
                noteEditorContainer.classList.add('flex');
                emptyEditorState.classList.add('hidden');
                
                // Hide list on mobile when editor is open
                if (isMobile) {
                    document.getElementById('note-list-container').classList.add('hidden');
                }

                // Populate editor fields
                noteTitleInput.value = activeNote.title || '';
                noteContentTextarea.value = activeNote.content || '';
                lastEditedTimeSpan.textContent = 'Last edited: ' + formatTimestamp(activeNote.updatedAt);
                deleteNoteBtn.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                // Clear and hide editor
                noteTitleInput.value = '';
                noteContentTextarea.value = '';
                lastEditedTimeSpan.textContent = 'Last edited: --';
                deleteNoteBtn.classList.add('opacity-50', 'pointer-events-none');

                // Determine what to show when no note is active
                if (window.innerWidth >= 768) {
                    // Desktop: Show list and empty editor state
                    document.getElementById('note-list-container').classList.remove('hidden');
                    noteEditorContainer.classList.add('hidden');
                    noteEditorContainer.classList.remove('flex');
                    emptyEditorState.classList.remove('hidden');
                } else {
                    // Mobile: Show list only
                    document.getElementById('note-list-container').classList.remove('hidden');
                    noteEditorContainer.classList.add('hidden');
                    noteEditorContainer.classList.remove('flex');
                    emptyEditorState.classList.add('hidden');
                }
            }

            renderNoteList();
        };

        // --- EVENT HANDLERS ---

        const setupEventListeners = () => {
            // --- Routing Events ---
            window.addEventListener('hashchange', handleRouting);
            
            // --- Auth Events ---
            authPrimaryBtn.addEventListener('click', handlePrimaryAuthAction);
            authGoogleBtn.addEventListener('click', handleGoogleSignIn);
            
            [authEmailInput, authPasswordInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handlePrimaryAuthAction();
                    }
                });
            });

            // --- App Events ---
            signoutBtn.addEventListener('click', handleSignOut);
            newNoteBtn.addEventListener('click', createNewNote);

            // Auto-save logic with debounce
            const handleInputChange = () => {
                if (!activeNoteId || !userId) return;

                const title = noteTitleInput.value;
                const content = noteContentTextarea.value;
                
                if (saveTimer) {
                    clearTimeout(saveTimer);
                }

                saveTimer = setTimeout(() => {
                    saveActiveNote(title, content);
                }, 1000);
            };

            noteTitleInput.addEventListener('input', handleInputChange);
            noteContentTextarea.addEventListener('input', handleInputChange);

            // Delete button shows confirmation modal
            deleteNoteBtn.addEventListener('click', () => {
                if (activeNoteId) {
                    modalOverlay.classList.remove('hidden');
                    modalOverlay.classList.add('flex');
                }
            });

            // Modal handlers
            const hideModal = () => {
                modalOverlay.classList.add('hidden');
                modalOverlay.classList.remove('flex');
            };
            modalCancelBtn.addEventListener('click', hideModal);
            modalConfirmBtn.addEventListener('click', async () => {
                hideModal();
                await deleteNote();
            });

            // Mobile back button routes to list
            backToListBtn.addEventListener('click', () => {
                window.location.hash = '#/';
            });

            // Handle window resize for responsive layout
            window.addEventListener('resize', () => {
                setActiveNote(activeNoteId); 
            });
        };


        // --- APPLICATION START ---

        document.addEventListener('DOMContentLoaded', () => {
            // Check initial hash on load
            if (!window.location.hash) {
                window.location.hash = '#/';
            }
            
            lucide.createIcons();
            setupEventListeners();
            initializeFirebase();
        });

    </script>
</body>
</html>

